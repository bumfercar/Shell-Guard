#!/bin/bash

# main_analyzer.sh - Shell-Guard ë©”ì¸ ë¶„ì„ ìŠ¤í¬ë¦½íŠ¸
# PR ë³€ê²½ì‚¬í•­ ë¶„ì„, ë³´ì•ˆ ìŠ¤ìº”, ìŠ¤íƒ€ì¼ ê²€ì‚¬, AI ë¦¬ë·°ë¥¼ ìˆ˜í–‰í•˜ê³  ê²°ê³¼ë¥¼ GitHub PRì— ëŒ“ê¸€ë¡œ ì‘ì„±

set -e

# í™˜ê²½ ë³€ìˆ˜ ë¡œë“œ
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
source "${SCRIPT_DIR}/config/env.sh"

# ëª¨ë“ˆ ë¡œë“œ
source "${SCRIPT_DIR}/modules/git_diff.sh"
source "${SCRIPT_DIR}/modules/scanner.sh"
source "${SCRIPT_DIR}/modules/style_checker.sh"
source "${SCRIPT_DIR}/modules/ai_helper.sh"
source "${SCRIPT_DIR}/modules/github_api.sh"

# ========================================
# ë©”ì¸ ë¶„ì„ í•¨ìˆ˜
# ========================================
main() {
    log_info "=== Shell-Guard Analysis Started ==="

    # ì„ì‹œ ë””ë ‰í† ë¦¬ ìƒì„±
    create_tmp_dir

    # Trap ì„¤ì • (ì¢…ë£Œ ì‹œ ì„ì‹œ íŒŒì¼ ì •ë¦¬)
    trap cleanup_tmp_dir EXIT

    # í•„ìˆ˜ í™˜ê²½ ë³€ìˆ˜ í™•ì¸
    if ! check_required_env; then
        log_error "Required environment variables are missing"
        exit 1
    fi

    # í•„ìˆ˜ ë„êµ¬ ì„¤ì¹˜ í™•ì¸
    check_jq_installed || exit 1
    check_curl_installed || exit 1

    log_info "Repository: ${REPO_OWNER}/${REPO_NAME}"
    log_info "PR Number: ${PR_NUMBER}"

    # ========================================
    # 1ë‹¨ê³„: Git Diff ì¶”ì¶œ
    # ========================================
    log_info "Step 1: Extracting Git diff..."
    if ! extract_diff; then
        log_error "Failed to extract diff"
        exit 1
    fi

    # ========================================
    # 2ë‹¨ê³„: ë³´ì•ˆ ìŠ¤ìº”
    # ========================================
    log_info "Step 2: Running security scan..."
    run_security_scan
    security_status=$?

    # ë³´ì•ˆ ì´ìŠˆ ë°œê²¬ ì‹œ ì¦‰ì‹œ ì²˜ë¦¬
    if [ $security_status -eq 2 ]; then
        log_error "Critical security issues detected!"

        # ë³´ì•ˆ ì´ìŠˆ ë¦¬í¬íŠ¸ ìƒì„±
        generate_security_only_report

        # GitHubì— ëŒ“ê¸€ ì‘ì„± ë° ë³€ê²½ ìš”ì²­
        report_content=$(<"$FINAL_REPORT")
        post_pr_comment "$report_content"
        request_changes "ğŸš¨ ë³´ì•ˆ ì´ìŠˆê°€ ë°œê²¬ë˜ì—ˆìŠµë‹ˆë‹¤. ë¯¼ê° ì •ë³´ë¥¼ ì œê±°í•´ì£¼ì„¸ìš”."

        log_error "Analysis stopped due to security issues"
        exit 1
    fi

    # ========================================
    # 3ë‹¨ê³„: ìŠ¤íƒ€ì¼ ê²€ì‚¬
    # ========================================
    log_info "Step 3: Running style check..."
    run_style_check
    style_status=$?

    # ========================================
    # 4ë‹¨ê³„: AI ë¦¬ë·°
    # ========================================
    log_info "Step 4: Running AI review..."
    run_ai_review || true
    ai_status=$?

    # ========================================
    # 5ë‹¨ê³„: ìµœì¢… ë¦¬í¬íŠ¸ ìƒì„±
    # ========================================
    log_info "Step 5: Generating final report..."
    generate_final_report

    # ========================================
    # 6ë‹¨ê³„: GitHub PRì— ëŒ“ê¸€ ì‘ì„±
    # ========================================
    log_info "Step 6: Posting comment to GitHub PR..."
    report_content=$(<"$FINAL_REPORT")

    if ! post_pr_comment "$report_content"; then
        log_error "Failed to post comment to GitHub"
        exit 1
    fi

    log_success "=== Shell-Guard Analysis Completed Successfully ==="

    return 0
}

# ========================================
# í•¨ìˆ˜: ë³´ì•ˆ ì´ìŠˆ ì „ìš© ë¦¬í¬íŠ¸ ìƒì„±
# ========================================
generate_security_only_report() {
    log_info "Generating security-only report..."

    cat > "$FINAL_REPORT" <<EOF
### ğŸ” Shell-Guard ìë™ ë¦¬ë·° ê²°ê³¼

âš ï¸ **CRITICAL: ë³´ì•ˆ ì´ìŠˆ ê°ì§€**

ì´ PRì—ì„œ ë¯¼ê° ì •ë³´ê°€ ë°œê²¬ë˜ì–´ ì¶”ê°€ ë¶„ì„ì´ ì¤‘ë‹¨ë˜ì—ˆìŠµë‹ˆë‹¤.

---

#### ğŸ” ë³´ì•ˆ ê²€ì‚¬

$(format_scan_result_markdown)

---

**âš ï¸ ì¦‰ì‹œ ì¡°ì¹˜ í•„ìš”:**
1. ëª¨ë“  ë¯¼ê° ì •ë³´ë¥¼ ì½”ë“œì—ì„œ ì œê±°í•˜ì„¸ìš”
2. ë°œê²¬ëœ í‚¤/í† í°ì´ ìœ ì¶œëœ ê²½ìš° ì¦‰ì‹œ íê¸°í•˜ê³  ìƒˆë¡œ ë°œê¸‰í•˜ì„¸ìš”
3. í™˜ê²½ ë³€ìˆ˜ ë˜ëŠ” ì‹œí¬ë¦¿ ê´€ë¦¬ ì‹œìŠ¤í…œì„ ì‚¬ìš©í•˜ì„¸ìš”
4. ì ˆëŒ€ ì»¤ë°‹ íˆìŠ¤í† ë¦¬ì— ë¯¼ê° ì •ë³´ë¥¼ ë‚¨ê¸°ì§€ ë§ˆì„¸ìš”

---

*Automatically generated by Shell-Guard*
EOF
}

# ========================================
# í•¨ìˆ˜: ìµœì¢… ë¦¬í¬íŠ¸ ìƒì„±
# ========================================
generate_final_report() {
    log_info "Generating comprehensive report..."

    # ë³€ê²½ ìš”ì•½ ì •ë³´
    local diff_summary
    diff_summary=$(generate_diff_summary)

    # ë³´ì•ˆ ìŠ¤ìº” ê²°ê³¼
    local security_result
    security_result=$(format_scan_result_markdown)

    # ìŠ¤íƒ€ì¼ ê²€ì‚¬ ê²°ê³¼
    local style_result
    style_result=$(format_style_result_markdown)

    # AI ë¦¬ë·° ê²°ê³¼
    local ai_result
    ai_result=$(format_ai_result_markdown)

    # ìµœì¢… ë¦¬í¬íŠ¸ ì‘ì„±
    cat > "$FINAL_REPORT" <<EOF
### ğŸ” Shell-Guard ìë™ ë¦¬ë·° ê²°ê³¼

---

#### ğŸ“Œ ë³€ê²½ ìš”ì•½

$diff_summary

**ë³€ê²½ëœ íŒŒì¼ ëª©ë¡:**
\`\`\`
$(get_changed_files)
\`\`\`

---

#### ğŸ” ë³´ì•ˆ ê²€ì‚¬

$security_result

---

#### ğŸ§¹ ìŠ¤íƒ€ì¼ ê²€ì‚¬

$style_result

---

#### ğŸ¤– AI ë¦¬ë·°

$ai_result

---

#### ğŸ“Š ë¶„ì„ ì™„ë£Œ ì‹œê°„

**ë¶„ì„ ì‹œê°:** $(date '+%Y-%m-%d %H:%M:%S %Z')

---

*Automatically generated by Shell-Guard*
EOF

    log_success "Final report generated: $FINAL_REPORT"
}

# ========================================
# ë©”ì¸ ì‹¤í–‰
# ========================================
if [ "${BASH_SOURCE[0]}" == "${0}" ]; then
    main "$@"
    exit $?
fi
