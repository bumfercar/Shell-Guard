#!/bin/bash

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
source "${SCRIPT_DIR}/config/env.sh"

source "${SCRIPT_DIR}/modules/git_diff.sh"
source "${SCRIPT_DIR}/modules/scanner.sh"
source "${SCRIPT_DIR}/modules/style_checker.sh"
source "${SCRIPT_DIR}/modules/ai_helper.sh"
source "${SCRIPT_DIR}/modules/github_api.sh"

main() {
    log_info "=== Shell-Guard Analysis Started ==="

    create_tmp_dir
    trap cleanup_tmp_dir EXIT

    check_required_env || exit 1
    check_jq_installed || exit 1
    check_curl_installed || exit 1

    log_info "Repository: ${REPO_OWNER}/${REPO_NAME}"
    log_info "PR Number: ${PR_NUMBER}"

    log_info "Step 1: Extracting Git diff..."
    extract_diff || exit 1

    log_info "Step 2: Running security scan..."
    run_security_scan
    security_status=$?

    if [ "$security_status" -eq 2 ]; then
        log_warning "Security issues detected"
    elif [ "$security_status" -eq 0 ]; then
        log_success "No security issues found"
    fi

    log_info "Step 3: Running style check..."
    run_style_check

    log_info "Step 4: Running AI review..."
    run_ai_review || true

    log_info "Step 5: Generating final report..."
    generate_final_report

    log_info "Step 6: Posting comment to GitHub PR..."
    report_content=$(<"$FINAL_REPORT")
    post_pr_comment "$report_content" || true

    if [ "$security_status" -eq 2 ]; then
        log_warning "Requesting changes due to security issues..."
        request_changes "ðŸš¨ ë³´ì•ˆ ì´ìŠˆê°€ ë°œê²¬ë˜ì—ˆìŠµë‹ˆë‹¤. PR ëŒ“ê¸€ì˜ ìƒì„¸ ê°€ì´ë“œë¥¼ í™•ì¸í•˜ê³  ë¯¼ê° ì •ë³´ë¥¼ ì œê±°í•´ì£¼ì„¸ìš”." || true
    fi

    log_success "=== Shell-Guard Analysis Completed Successfully ==="
    exit 0
}

generate_final_report() {
    local diff_summary security_result style_result ai_result
    diff_summary=$(generate_diff_summary)
    security_result=$(format_scan_result_markdown)
    style_result=$(format_style_result_markdown)
    ai_result=$(format_ai_result_markdown)

    cat > "$FINAL_REPORT" <<EOF
### ðŸ” Shell-Guard ìžë™ ë¦¬ë·° ê²°ê³¼

---

#### ðŸ“Œ ë³€ê²½ ìš”ì•½

$diff_summary

**ë³€ê²½ëœ íŒŒì¼ ëª©ë¡:**
\`\`\`
$(get_changed_files)
\`\`\`

---

#### ðŸ” ë³´ì•ˆ ê²€ì‚¬

$security_result

---

#### ðŸ§¹ ìŠ¤íƒ€ì¼ ê²€ì‚¬

$style_result

---

#### ðŸ¤– AI ë¦¬ë·°

$ai_result

---

**ë¶„ì„ ì‹œê°:** $(date '+%Y-%m-%d %H:%M:%S %Z')

*Automatically generated by Shell-Guard*
EOF
}

if [ "${BASH_SOURCE[0]}" == "${0}" ]; then
    main "$@"
fi
